# Рамочный документ: Древовидное хранение диалогов

## Обзор

В данном проекте реализована система хранения диалогов в виде древовидной структуры, где каждое высказывание (от пользователя или LLM) является узлом данных. Эта архитектура позволяет сохранять полную историю взаимодействий с возможностью ветвления, создания альтернативных путей разговора и анализа различных сценариев диалога.

## Архитектурные принципы

### 1. Древовидная структура
- Каждый узел имеет уникальный идентификатор
- Узлы связаны через родительско-дочерние отношения
- Поддерживается возможность ветвления диалога
- Структура аналогична mindmap картам

### 2. Узел данных
Каждый узел содержит:
- `id`: уникальный идентификатор узла
- `parentId`: идентификатор родительского узла (null для корневого узла)
- `childrenIds`: массив идентификаторов дочерних узлов
- `content`: текстовое содержимое высказывания
- `sender`: тип отправителя ('user' или 'bot')
- `timestamp`: время создания узла
- `sources`: массив источников/доказательств (для верификации)
- `expanded`, `selected`: UI-состояния для отображения

### 3. Хранение и персистентность
- Используется локальное хранилище браузера (localStorage)
- Данные сериализуются в JSON формат
- Поддерживается экспорт/импорт данных
- Служба `ConceptTreeService` управляет всеми операциями с деревом

## Структура данных

### Интерфейс ConceptNode
```typescript
export interface ConceptNode {
  id: string
  parentId: string | null
  childrenIds: string[]
  content: string // Текст высказывания
  sources: Source[] // Массив источников для верификации
  timestamp: number // Время создания в миллисекундах
  embedding?: number[] // Векторное представление (опционально)
  expanded?: boolean // Состояние раскрытия для UI
  selected?: boolean // Состояние выбора для UI
}
```

### Интерфейс Source
```typescript
export interface Source {
  id: string
  url: string
  title?: string
  type: 'confirm' | 'doubt' // Тип источника
  tool?: string // Инструмент, который создал источник
 sentiment?: 'positive' | 'negative' | 'neutral' // Эмоциональная окраска
 userConfirmed?: boolean // Подтверждение пользователем
  reliabilityScore?: number // Оценка надежности
  timestamp: number
}
```

## API для работы с древовидными диалогами

### ConceptTreeService API

#### Основные методы
- `addConcept(parentId: string | null, content: string): ConceptNode`
  - Добавляет новый узел к указанному родителю
  - Создает корневой узел, если parentId равен null
  - Возвращает созданный узел

- `getNode(id: string): ConceptNode | undefined`
  - Получает узел по идентификатору

- `getRoot(): ConceptNode | null`
  - Получает корневой узел дерева

- `getAllNodes(): ConceptNode[]`
  - Возвращает все узлы дерева

- `search(query: string): ConceptNode[]`
  - Поиск узлов по содержимому

#### Управление состоянием UI
- `setSelected(nodeId: string, selected: boolean): void`
  - Устанавливает состояние выбора узла

- `toggleSelected(nodeId: string): void`
  - Переключает состояние выбора узла

- `getSelectedNodes(): ConceptNode[]`
  - Получает все выбранные узлы

- `clearSelection(): void`
  - Сбрасывает выбор всех узлов

- `setExpanded(nodeId: string, expanded: boolean): void`
  - Устанавливает состояние раскрытия узла

- `toggleExpanded(nodeId: string): void`
  - Переключает состояние раскрытия узла

#### Персистентность
- `persist(): void`
  - Сохраняет текущее состояние в localStorage

- `clear(): void`
  - Очищает все данные

- `exportData(): string`
  - Экспортирует данные в JSON формате

- `importData(dataStr: string): void`
  - Импортирует данные из JSON строки

#### Управление чат-сессиями
- `getChatSessions(): ConceptNode[]`
  - Получает все корневые узлы (чат-сессии)

- `getChatSessionById(id: string): ConceptNode | undefined`
 - Получает чат-сессию по ID

### Дополнительные методы
- `addSource(conceptId: string, source: Omit<Source, 'id' | 'timestamp'>): Source`
  - Добавляет источник к узлу

## Компоненты пользовательского интерфейса

### ConversationTree
Основной компонент для отображения древовидной структуры диалога:
- Отображает узлы в виде иерархического дерева
- Поддерживает раскрытие/свертывание ветвей
- Позволяет выбирать узлы для продолжения диалога
- Имеет поле ввода для добавления новых ответов
- Поддерживает выделение узлов

### ChatSidebar
Боковая панель с историей чатов:
- Отображает последние чат-сессии
- Позволяет переключаться между сессиями
- Показывает предварительный просмотр содержимого

## Потоки данных

### Создание нового узла
1. Пользователь выбирает узел, от которого хочет продолжить диалог
2. Вводит новое сообщение в поле ввода
3. Нажимает кнопку отправки
4. Вызывается `conceptTreeService.addConcept()` с ID выбранного узла
5. Создается новый узел и добавляется в дерево
6. Обновляется состояние UI

### Загрузка дерева
1. При инициализации компонента `ConversationTree`
2. Вызывается `conceptTreeService.getAllNodes()`
3. Данные преобразуются в древовидную структуру
4. Устанавливается начальное состояние компонента

### Выбор узла для продолжения
1. Пользователь кликает по узлу в дереве
2. Вызывается `conceptTreeService.setSelected()` для пометки узла
3. Устанавливается контекст для нового ответа
4. Обновляется UI для отображения выбранного узла

## Проверка кода для древовидной архитектуры

### Архитектурные проверки
1. **Целостность связей**: Проверка, что все parentId ссылаются на существующие узлы
2. **Уникальность ID**: Проверка, что все узлы имеют уникальные идентификаторы
3. **Циклические зависимости**: Проверка отсутствия циклических связей в дереве
4. **Корректность корневых узлов**: Проверка, что у дерева есть корневой узел

### Проверки производительности
1. **Глубина дерева**: Ограничение максимальной глубины для предотвращения переполнения стека
2. **Количество узлов**: Ограничение общего количества узлов для предотвращения замедления UI
3. **Оптимизация рендеринга**: Использование memoization для сложных операций

### Проверки безопасности
1. **Валидация ввода**: Проверка и очистка пользовательского ввода
2. **Ограничение доступа**: Проверка прав доступа к узлам (при наличии аутентификации)
3. **Защита от XSS**: Санитизация HTML-содержимого узлов

### Проверки персистентности
1. **Валидация данных**: Проверка структуры данных при загрузке из localStorage
2. **Обработка ошибок**: Корректная обработка сбоев при сохранении/загрузке
3. **Миграции данных**: Поддержка обновления формата данных при изменении структуры

## Паттерны использования

### 1. Ветвление диалога
Пользователь может создавать альтернативные ветви разговора, выбирая разные ответы на одно и то же высказывание.

### 2. Анализ сценариев
Различные ветви дерева позволяют анализировать разные сценарии взаимодействия и их последствия.

### 3. Обучение и валидация
Использование источников и подтверждений для проверки достоверности информации в узлах.

## Расширения и будущие улучшения

### Возможные расширения
1. **Поддержка мультимедиа**: Добавление изображений, аудио и видео к узлам
2. **Коллаборативная работа**: Поддержка нескольких пользователей в одном дереве
3. **Векторные поиски**: Использование embeddings для семантического поиска
4. **API для интеграций**: REST или GraphQL API для внешних систем
5. **Резервное копирование**: Автоматическое сохранение на сервере

### Потенциальные улучшения
1. **Оптимизация производительности**: Виртуализация для больших деревьев
2. **Улучшенный UI**: Поддержка drag-and-drop, визуальные улучшения
3. **Аналитика**: Статистика по дереву, метрики взаимодействия
4. **Экспорт в различные форматы**: PDF, DOCX, JSON, другие mindmap форматы