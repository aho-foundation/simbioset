# Примеры для классификации тегов в Weaviate

## Обзор

Для **Contextual Classification** в Weaviate нужны примеры для каждого тега (класса). Weaviate использует векторные представления примеров для классификации новых параграфов.

## Требования к примерам

### Минимальное количество

- **Минимум:** 3-5 примеров на тег (для базовой работы)
- **Рекомендуется:** 10-20 примеров на тег (для хорошей точности)
- **Оптимально:** 20-50 примеров на тег (для высокой точности)

### Качество примеров

Примеры должны быть:
- ✅ **Репрезентативными** - отражать типичные случаи использования тега
- ✅ **Разнообразными** - показывать разные формулировки одной идеи
- ✅ **Достаточно длинными** - минимум 50-100 символов, оптимально 100-300
- ✅ **Релевантными** - четко соответствовать тегу

## Примеры для каждого тега

### 1. `ecosystem_vulnerability` (Уязвимости экосистемы)

**Описание:** Возможные риски и слабые места в экосистеме, которые могут привести к проблемам.

**Примеры:**

```python
examples = [
    "Лесная экосистема становится уязвимой из-за изменения климата. Участившиеся засухи приводят к ослаблению деревьев и повышению риска пожаров.",
    "Популяция пчел в регионе снижается из-за использования пестицидов. Это создает уязвимость для опыления растений и стабильности экосистемы.",
    "Загрязнение водоемов промышленными отходами делает водную экосистему уязвимой. Рыбы и другие организмы могут погибнуть из-за токсинов.",
    "Инвазивные виды растений вытесняют местную флору, создавая уязвимость в экосистеме. Это нарушает баланс и может привести к исчезновению эндемичных видов.",
    "Фрагментация лесов из-за вырубки создает уязвимость для миграции животных. Это нарушает экологические связи между популяциями.",
]
```

### 2. `ecosystem_risk` (Риски экосистемы)

**Описание:** Найденные проблемы, требующие немедленного решения или внимания.

**Примеры:**

```python
examples = [
    "В озере обнаружено критическое снижение уровня кислорода. Рыбы массово гибнут, экосистема находится под угрозой коллапса.",
    "Пожар уничтожил 30% лесного массива. Восстановление займет десятилетия, многие виды потеряли среду обитания.",
    "Загрязнение почвы тяжелыми металлами достигло опасного уровня. Растения накапливают токсины, что угрожает всей пищевой цепи.",
    "Инвазивный вид моллюсков захватил озеро, вытесняя местные виды. Экосистема быстро деградирует, требуется срочное вмешательство.",
    "Изменение климата привело к таянию ледников. Реки пересыхают, водные экосистемы теряют источник воды.",
]
```

### 3. `suggested_ecosystem_solution` (Предлагаемые решения)

**Описание:** Конкретные предложения по улучшению или восстановлению экосистемы.

**Примеры:**

```python
examples = [
    "Для восстановления популяции пчел рекомендуется создать цветущие полосы вдоль полей и ограничить использование пестицидов в период цветения.",
    "Восстановление леса можно ускорить посадкой местных видов деревьев и созданием защитных зон от пожаров.",
    "Очистка водоема от загрязнений требует установки фильтров на промышленных стоках и восстановления прибрежной растительности.",
    "Контроль инвазивных видов возможен через механическое удаление и биологический контроль с помощью естественных врагов.",
    "Для защиты миграционных путей животных необходимо создавать экологические коридоры между фрагментированными участками леса.",
]
```

### 4. `neutral` (Нейтральный контент)

**Описание:** Информационный контент без специфической классификации (описания, факты, общая информация).

**Примеры:**

```python
examples = [
    "Лесная экосистема состоит из различных видов деревьев, кустарников, трав и животных, которые взаимодействуют друг с другом.",
    "Пчелы собирают нектар с цветов и переносят пыльцу, способствуя опылению растений.",
    "Водная экосистема включает в себя рыбы, водоросли, планктон и другие организмы, живущие в воде.",
    "Экосистема - это сообщество живых организмов и их физической среды, взаимодействующих как единое целое.",
    "Разнообразие видов в экосистеме называется биоразнообразием и является важным показателем здоровья экосистемы.",
]
```

## Как использовать примеры в Weaviate v4

### Вариант 1: Contextual Classification (с примерами)

```python
from weaviate.classes.config import Configure, Property, DataType
from weaviate.classes.classification import ClassificationType

# Создаем класс для классификации
client.collections.create(
    name="Paragraph",
    properties=[
        Property(name="content", data_type=DataType.TEXT),
        Property(name="classification", data_type=DataType.TEXT),
    ],
    vectorizer_config=Configure.Vectorizer.text2vec_openai(),  # или другой модуль
)

# Добавляем примеры для каждого класса
# Weaviate автоматически использует их для классификации
examples_by_class = {
    "ecosystem_vulnerability": [
        "Лесная экосистема становится уязвимой...",
        "Популяция пчел снижается...",
        # ... остальные примеры
    ],
    "ecosystem_risk": [
        "В озере обнаружено критическое снижение...",
        # ... остальные примеры
    ],
    # ... остальные классы
}

# При добавлении нового параграфа Weaviate автоматически классифицирует его
# на основе близости к примерам классов
```

### Вариант 2: Zero-shot Classification (без примеров, только описания)

```python
# Для Zero-shot нужны только описания классов, примеры не требуются
class_descriptions = {
    "ecosystem_vulnerability": "Уязвимости экосистемы - возможные риски и слабые места",
    "ecosystem_risk": "Риски экосистемы - найденные проблемы, требующие решения",
    "suggested_ecosystem_solution": "Предлагаемые решения для экосистемы",
    "neutral": "Нейтральный контент без специфической классификации",
}
```

## Интеграция с текущей системой

### Использование примеров из БД

```python
from api.classify.tag_service import TagService

tag_service = TagService(db_manager)

# Получаем теги с примерами из БД
tags = tag_service.get_all_tags(active_only=True)

for tag in tags:
    examples = tag.get("examples", [])
    if examples:
        # Используем примеры для настройки Weaviate классификации
        weaviate_client.add_class_examples(
            class_name=tag["name"],
            examples=examples
        )
```

### Автоматическое обновление примеров

```python
# При классификации через LLM автоматически добавляем примеры
async def classify_with_learning(paragraph: Paragraph, tag_service: TagService):
    # Классифицируем через LLM
    tags = await tag_service.suggest_tags_for_paragraph(paragraph.content)
    
    # Добавляем параграф как пример для каждого тега
    for tag in tags:
        tag_service.add_example_to_tag(tag, paragraph.content[:200])
    
    return tags
```

## Рекомендации

### Для начала работы

1. **Минимум 5 примеров** на каждый тег из существующих параграфов
2. **Выбирайте разнообразные примеры** - разные формулировки, разные контексты
3. **Проверяйте качество** - примеры должны четко соответствовать тегу

### Для улучшения точности

1. **Увеличьте до 20 примеров** на тег
2. **Регулярно обновляйте примеры** - добавляйте новые, удаляйте устаревшие
3. **Балансируйте примеры** - примерно одинаковое количество для каждого тега

### Для production

1. **20-50 примеров** на тег для высокой точности
2. **Автоматическое обучение** - добавляйте примеры из успешных классификаций LLM
3. **Мониторинг точности** - отслеживайте качество классификации и корректируйте примеры

## Гибридный подход (рекомендуется)

```python
async def hybrid_classify(paragraph: Paragraph, weaviate_client, tag_service):
    """Гибридная классификация: Weaviate для частых случаев, LLM для сложных"""
    
    # 1. Пробуем классификацию через Weaviate (быстро)
    weaviate_tags = weaviate_client.classify(
        text=paragraph.content,
        classes=["ecosystem_vulnerability", "ecosystem_risk", 
                 "suggested_ecosystem_solution", "neutral"]
    )
    
    # 2. Если уверенность высокая - используем результат
    if weaviate_tags and weaviate_tags[0].confidence > 0.8:
        return weaviate_tags[0].class_name
    
    # 3. Иначе используем LLM (точно, но медленнее)
    llm_tags = await tag_service.suggest_tags_for_paragraph(paragraph.content)
    
    # 4. Добавляем как пример для обучения Weaviate
    if llm_tags:
        tag_service.add_example_to_tag(llm_tags[0], paragraph.content[:200])
    
    return llm_tags[0] if llm_tags else "neutral"
```

## Связанные документы

- [WEAVIATE_CLASSIFICATION.md](../weaviate_classification.md) - Обзор классификации в Weaviate
- [WEAVIATE_SCHEMA_FIRST.md](WEAVIATE_SCHEMA_FIRST.md) - Схема данных
- `api/classify/tag_service.py` - Сервис управления тегами
